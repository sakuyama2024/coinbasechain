version: '3.8'

services:
  # ============================================================================
  # Main CoinbaseChain Node
  # ============================================================================
  node:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: coinbasechain:latest
    container_name: coinbasechain-node
    hostname: coinbasechain-node
    restart: unless-stopped

    # Port mappings for P2P networking
    ports:
      - "9590:9590"   # Mainnet P2P

    # Persistent data volume
    volumes:
      - coinbasechain-data:/home/coinbasechain/.coinbasechain

    # Environment variables for configuration
    environment:
      - COINBASECHAIN_THREADS=4
      - COINBASECHAIN_VERBOSE=1

    # Default command-line arguments
    command: [
      "--listen",
      "--verbose",
      "--threads=4",
      "--datadir=/home/coinbasechain/.coinbasechain"
    ]

    # Health check via CLI
    healthcheck:
      test: ["CMD", "coinbasechain-cli", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

  # ============================================================================
  # Testnet Node (use profile: docker-compose --profile testnet up)
  # ============================================================================
  testnet:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinbasechain:latest
    container_name: coinbasechain-testnet
    hostname: coinbasechain-testnet
    restart: unless-stopped
    profiles: ["testnet"]

    ports:
      - "19590:19590"   # Testnet P2P

    volumes:
      - coinbasechain-testnet-data:/home/coinbasechain/.coinbasechain

    command: [
      "--testnet",
      "--listen",
      "--verbose",
      "--threads=2",
      "--datadir=/home/coinbasechain/.coinbasechain"
    ]

    healthcheck:
      test: ["CMD", "coinbasechain-cli", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Regtest Node (use profile: docker-compose --profile regtest up)
  # ============================================================================
  regtest:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinbasechain:latest
    container_name: coinbasechain-regtest
    hostname: coinbasechain-regtest
    restart: unless-stopped
    profiles: ["regtest"]

    ports:
      - "29590:29590"   # Regtest P2P

    volumes:
      - coinbasechain-regtest-data:/home/coinbasechain/.coinbasechain

    command: [
      "--regtest",
      "--listen",
      "--verbose",
      "--threads=1",
      "--datadir=/home/coinbasechain/.coinbasechain"
    ]

    healthcheck:
      test: ["CMD", "coinbasechain-cli", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Debug Node with TRACE logging (use profile: docker-compose --profile debug up)
  # For debugging chain/network issues with comprehensive TRACE output
  # ============================================================================
  debug:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinbasechain:latest
    container_name: coinbasechain-debug
    hostname: coinbasechain-debug
    restart: unless-stopped
    profiles: ["debug"]

    ports:
      - "29590:29590"   # Regtest port for debugging

    volumes:
      - coinbasechain-debug-data:/home/coinbasechain/.coinbasechain

    environment:
      # Enable TRACE logging for all components
      - COINBASECHAIN_DEBUG=all

    command: [
      "--regtest",
      "--listen",
      "--threads=1",
      "--datadir=/home/coinbasechain/.coinbasechain",
      "--debug=all"
    ]

    healthcheck:
      test: ["CMD", "coinbasechain-cli", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Test Runner (use profile: docker-compose --profile test up)
  # ============================================================================
  tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: coinbasechain:test
    container_name: coinbasechain-tests
    profiles: ["test"]

    # Environment for test configuration
    environment:
      # Set to 'trace' to enable TRACE logging in tests
      - COINBASE_TEST_LOG_LEVEL=info

    # Run tests and exit
    command: ["./coinbasechain_tests", "-v"]

    # Mount source for potential test coverage reports
    volumes:
      - ./test:/workspace/test:ro

  # ============================================================================
  # Test Runner with TRACE logging (use profile: docker-compose --profile test-trace up)
  # For debugging test failures with comprehensive TRACE output
  # ============================================================================
  tests-trace:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: coinbasechain:test
    container_name: coinbasechain-tests-trace
    profiles: ["test-trace"]

    environment:
      # Enable TRACE logging for all test output
      - COINBASE_TEST_LOG_LEVEL=trace

    # Run tests with TRACE logging
    command: ["./coinbasechain_tests", "-v"]

    volumes:
      - ./test:/workspace/test:ro

# ============================================================================
# Named Volumes for Persistent Data
# ============================================================================
volumes:
  coinbasechain-data:
    driver: local
    name: coinbasechain-mainnet-data

  coinbasechain-testnet-data:
    driver: local
    name: coinbasechain-testnet-data

  coinbasechain-regtest-data:
    driver: local
    name: coinbasechain-regtest-data

  coinbasechain-debug-data:
    driver: local
    name: coinbasechain-debug-data

# ============================================================================
# Networks (optional: use custom network for node communication)
# ============================================================================
networks:
  default:
    name: coinbasechain-network
    driver: bridge
